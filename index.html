<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awesome Technical English Quiz (Real-Time Tally) 🚀</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles based on the provided design image */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #9333ea; /* Purple background color */
            background-image: url('data:image/svg+xml;utf8,<svg width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="pattern-07e53f" patternUnits="userSpaceOnUse" width="100" height="100" patternTransform="scale(1) rotate(0)"><path d="M 0 0 L 0 50 L 50 100 L 100 50 L 50 0 L 0 50" stroke="%23a855f7" stroke-width="1.5" fill="none"/></pattern></defs><rect width="100%" height="100%" fill="url(%23pattern-07e53f)" opacity="0.3"/></svg>');
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 600px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .option-label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid #3b82f6; /* Blue border for all options */
            color: #1f2937;
            background-color: #eff6ff; /* Light blue background */
        }
        .option-label:hover {
            background-color: #dbeafe; /* Lighter blue on hover */
        }
        /* Highlight for the option with the current majority of votes */
        .option-label.majority {
            border-width: 4px; /* Thicker border for majority */
            border-color: #3b82f6;
            background-color: #dbeafe; /* Slightly darker light blue */
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -2px rgba(59, 130, 246, 0.2);
        }
        /* Highlight for the FIXED correct answer after locking in */
        .option-label.correct {
            border-color: #10b981; /* Green border for correct */
            background-color: #d1fae5; /* Light green background */
        }
        /* Highlight for the INCORRECT group majority answer after locking in */
        .option-label.incorrect-majority {
            border-color: #ef4444; /* Red border for incorrect majority */
            background-color: #fee2e2; /* Light red background */
        }
        
        /* Custom button styling */
        #lock-in-btn {
            background-color: #10b981; /* Primary Green */
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            box-shadow: 0 4px 0 0 #059669; /* Darker green shadow */
            transition: all 0.1s ease-in-out;
        }
        #lock-in-btn:hover {
            background-color: #059669;
        }
        #lock-in-btn:active {
            box-shadow: 0 1px 0 0 #059669;
            transform: translateY(3px);
        }
        .red-button {
            background-color: #ef4444;
            box-shadow: 0 4px 0 0 #dc2626;
        }
        .red-button:hover {
            background-color: #dc2626;
        }
        .red-button:active {
            box-shadow: 0 1px 0 0 #dc2626;
            transform: translateY(3px);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10b981',
                        'secondary-blue': '#3b82f6',
                        'quiz-purple': '#9333ea',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto">
        <div id="quiz-container" class="card p-6 sm:p-8">
            <!-- Dynamic quiz content will be rendered here -->
        </div>
        
        <div class="text-center mt-6">
            <button onclick="window.resetAllData()" class="red-button px-4 py-2 text-white font-bold text-sm rounded-lg shadow-lg transition duration-200">
                Reset All Votes & Progress
            </button>
            <p class="text-xs text-white opacity-80 mt-1">Clears all stored data to restart with 0 votes on all questions.</p>
        </div>
    </div>

    <script>
        // --- QUIZ DATA ---
        // Content based on Cyber Safety materials
        const tests = [
            {
                id: 'test1',
                title: 'Passage 1: Password Sharing (Risk 1)',
                icon: '🔑 Cyber Safety Quiz 🔒',
                text: 
                    "CYBER SAFETY is your job to stay **safe in the Internet world**. Your password is your **SECRET KEY**. This key lets you enter your account. **PASSWORD SHARING** is when you give your secret key to someone else, even a friend like Tom. This is the **biggest risk**. The rule is simple: you must **NEVER** share your password. If a friend asks for your password to help you get better things in a game, you must **SAY NO**. We must remember that **Trust** means to believe that someone is good and honest.",
                questions: [
                    { q: "What is your password called in this text?", options: ["The Key Access", "The Secret Key", "The Trust Code", "The Game Pass"], correct: 1 },
                    { q: "What does PASSWORD SHARING mean?", options: ["Changing your key often.", "Giving your key to someone else.", "Checking your friend's key.", "Getting a better game."], correct: 1 },
                    { q: "What is the simple rule for your password?", options: ["Share it with Tom.", "Write it down.", "NEVER share it.", "Share it only once."], correct: 2 },
                    { q: "What does the word TRUST mean?", options: ["To say 'no'.", "To believe someone is good.", "To share a key.", "To stay safe."], correct: 1 },
                    { q: "Password Sharing is described as the...", options: ["best action.", "smallest risk.", "biggest risk.", "safest choice."], correct: 2 },
                ]
            },
            {
                id: 'test2',
                title: 'Passage 2: App Access (Risk 7)',
                icon: '📱 Permissions Check ✅',
                text: 
                    "When you install an app from a safe store, it will ask you to **GIVE ACCESS**. This means you **permit** the app to use your device's features, like your camera, photos, or **Location**. For example, a map app needs access to your Location to work, but a flashlight app does not. If an app asks for strange access, you must **READ CAREFULLY** and **SAY NO**. You can always check the access permissions later in your phone's settings. The list of people you know on your phone is called your **Contacts**.",
                questions: [
                    { q: "What does GIVE ACCESS mean?", options: ["To close the app.", "To let the app use your device features.", "To uninstall the app.", "To check the password."], correct: 1 },
                    { q: "What should you do if an app asks for strange access?", options: ["Say 'Yes' quickly.", "READ CAREFULLY and SAY NO.", "Share your password.", "Install a free game."], correct: 1 },
                    { q: "Which app likely needs Location access?", options: ["A clock app.", "A music player.", "A map app.", "A calculator."], correct: 2 },
                    { q: "What is the list of people you know on your phone called?", options: ["The Location Tag", "The Access List", "The Contacts", "The Homepage"], correct: 2 },
                    { q: "What can you do later in the device settings?", options: ["Delete the whole app.", "Check and change access permissions.", "Download a virus.", "Start a video."], correct: 1 },
                ]
            }
        ];


        // --- STATE AND LOCAL STORAGE MANAGEMENT ---
        let state = {
            currentTestIndex: 0,
            currentQuestionIndex: 0,
            isReadingPhase: true,
            // Stores vote counts as an array: { 'test1-q0': [3, 5, 2, 0] }
            allVotes: {}, 
            // Stores the correct/incorrect status for fixed answer key comparison
            questionStatus: tests.reduce((acc, test) => { acc[test.id] = {}; return acc; }, {}),
            // Stores the index of the option that currently holds the majority vote
            majorityVote: tests.reduce((acc, test) => { acc[test.id] = {}; return acc; }, {}),
        };
        
        const quizContainer = document.getElementById('quiz-container');

        // Load data from local storage
        function loadData() {
            const storedVotes = localStorage.getItem('quizAllVotes');
            if (storedVotes) {
                state.allVotes = JSON.parse(storedVotes);
            }

            const storedState = localStorage.getItem('quizState');
            if (storedState) {
                const loadedState = JSON.parse(storedState);
                state.currentTestIndex = loadedState.currentTestIndex || 0;
                state.currentQuestionIndex = loadedState.currentQuestionIndex || 0;
                state.isReadingPhase = loadedState.isReadingPhase !== undefined ? loadedState.isReadingPhase : true;
                state.questionStatus = loadedState.questionStatus || state.questionStatus;
                state.majorityVote = loadedState.majorityVote || state.majorityVote;
            }
            
             // Initialize votes array for all questions if not present
            tests.forEach(test => {
                if (!state.allVotes[test.id]) state.allVotes[test.id] = {};
                test.questions.forEach((qData, qIndex) => {
                    const key = `q${qIndex}`;
                    if (!state.allVotes[test.id][key]) {
                        state.allVotes[test.id][key] = new Array(qData.options.length).fill(0);
                    }
                });
            });
        }

        // Save current state to local storage
        function saveData() {
            localStorage.setItem('quizAllVotes', JSON.stringify(state.allVotes));
            localStorage.setItem('quizState', JSON.stringify({
                currentTestIndex: state.currentTestIndex,
                currentQuestionIndex: state.currentQuestionIndex,
                isReadingPhase: state.isReadingPhase,
                questionStatus: state.questionStatus,
                majorityVote: state.majorityVote,
            }));
        }


        // --- CORE QUIZ LOGIC ---

        // Initial setup function
        function initQuiz() {
            loadData();
            renderCurrentTest();
        }
        
        // Function to clear all local storage data and restart the quiz
        function resetAllData() {
            localStorage.clear();
            window.location.reload(); 
        }

        // Renders the main structure for the current test (Reading Text + Question Area)
        function renderCurrentTest() {
            const currentTest = tests[state.currentTestIndex];
            
            if (state.isReadingPhase) {
                 state.currentQuestionIndex = 0;
            }

            // Set up the reading text section
            const readingSection = `
                <div id="reading-section" class="bg-gray-50 p-6 rounded-lg text-gray-700 border-l-4 border-quiz-purple/50 ${state.isReadingPhase ? '' : 'hidden'}">
                    <p class="whitespace-pre-wrap text-base">${currentTest.text}</p>
                    <p class="text-sm text-gray-500 mt-4 text-center">This section has questions 1 to ${currentTest.questions.length}.</p>
                    
                    <button onclick="startQuestions()" id="start-btn" class="mt-6 w-full red-button px-6 py-4 text-white font-bold rounded-xl shadow-lg transition duration-200 text-xl">
                        Start Questions for ${currentTest.title}
                    </button>
                </div>
            `;
            
            // Set up the main quiz container
            quizContainer.innerHTML = `
                <header class="text-center mb-6">
                    <h1 class="text-2xl font-extrabold text-quiz-purple">${currentTest.icon}</h1>
                    <h2 class="text-xl font-bold text-gray-700 mt-1">${currentTest.title}</h2>
                </header>

                <div id="quiz-body">
                    ${readingSection}

                    <!-- Question Section -->
                    <div id="question-section" class="${state.isReadingPhase ? 'hidden' : ''}">
                        <div id="question-content">
                            <!-- Question and options will be injected here -->
                        </div>
                        <div id="navigation-controls" class="mt-8 flex justify-between space-x-4">
                            <!-- Navigation buttons injected here -->
                        </div>
                    </div>
                </div>

                <!-- Message Box for Feedback -->
                <div id="feedback-box" class="mt-6 p-4 rounded-lg bg-yellow-100 border border-yellow-400 text-sm text-yellow-800 hidden">
                    <!-- Feedback injected here -->
                </div>
            `;
            
            if (!state.isReadingPhase) {
                displayCurrentQuestion();
            }

            saveData();
        }

        // Hides reading text and shows the current question
        function startQuestions() {
            document.getElementById('reading-section').classList.add('hidden');
            document.getElementById('question-section').classList.remove('hidden');
            state.isReadingPhase = false;
            displayCurrentQuestion();
        }
        
        // **CRITICAL FIX**: Increments the vote count for the selected option by 1
        function updateVote(qIndex, selectedOptionIndex) {
            const currentTest = tests[state.currentTestIndex];
            const testId = currentTest.id;
            const key = `q${qIndex}`;

            // Increment the specific option's count
            if (state.allVotes[testId] && state.allVotes[testId][key]) {
                state.allVotes[testId][key][selectedOptionIndex]++;
            } else {
                 console.error("Vote array not initialized!");
                 return;
            }
            
            saveData();
            
            // Re-render to show the updated vote counts and majority
            displayCurrentQuestion();
        }

        // Renders the current question based on state.currentQuestionIndex
        function displayCurrentQuestion() {
            const currentTest = tests[state.currentTestIndex];
            const qData = currentTest.questions[state.currentQuestionIndex];
            const qIndex = state.currentQuestionIndex;
            const testId = currentTest.id;
            const totalQuestions = currentTest.questions.length;
            const key = `q${qIndex}`;
            
            const questionContent = document.getElementById('question-content');
            const navigationControls = document.getElementById('navigation-controls');
            const feedbackBox = document.getElementById('feedback-box');

            const currentQuestionVotes = state.allVotes[testId] ? state.allVotes[testId][key] : new Array(qData.options.length).fill(0);
            
            // --- TALLY VOTES AND FIND MAJORITY ---
            let maxVotes = -1;
            let majorityAnswerIndex = -1;
            let totalVotesCast = 0;
            
            currentQuestionVotes.forEach((count, index) => {
                totalVotesCast += count;
                if (count > maxVotes) {
                    maxVotes = count;
                    majorityAnswerIndex = index;
                }
            });

            // Update stored majority for tracking and scoring
            if (!state.majorityVote[testId]) state.majorityVote[testId] = {};
            state.majorityVote[testId][qIndex] = majorityAnswerIndex;


            const isChecked = state.questionStatus[testId] && state.questionStatus[testId][qIndex] !== undefined;
            const isCorrect = isChecked ? state.questionStatus[testId][qIndex] : undefined;
            const correctAnswerIndex = qData.correct;

            // 1. Render Question Content
            questionContent.innerHTML = `
                <p class="text-center text-gray-500 mb-4 font-semibold">Question ${qIndex + 1} of ${totalQuestions}</p>
                <div class="question p-4 rounded-lg">
                    <p class="font-bold text-xl text-gray-800 mb-4">
                        ${qIndex + 1}. ${qData.q}
                    </p>
                    <div class="options space-y-3">
                        ${qData.options.map((option, oIndex) => {
                            const inputName = `${testId}-q${qIndex}`;
                            const isMajorityAnswer = oIndex === majorityAnswerIndex && maxVotes > 0;
                            const currentVoteCount = currentQuestionVotes[oIndex];

                            let labelClass = 'flex items-center justify-between p-4 rounded-xl option-label';
                            
                            // Highlight current vote majority (blue border)
                            if (isMajorityAnswer && !isChecked) {
                                labelClass += ' majority';
                            }
                            
                            // Fixed answer feedback
                            if (isChecked) {
                                // Highlight the FIXED correct answer with green
                                if (oIndex === correctAnswerIndex) {
                                    labelClass += ' correct';
                                }
                                // Highlight the group's chosen majority (if incorrect) with red
                                else if (oIndex === majorityAnswerIndex && oIndex !== correctAnswerIndex) {
                                     labelClass += ' incorrect-majority';
                                }
                                // Disable interactions after checking
                                labelClass += ' cursor-default';
                            }
                            
                            // The radio button is just for tracking the last clicked option, but the key is the onClick on the label
                            return `
                                <label 
                                    class="${labelClass}" 
                                    for="${inputName}-o${oIndex}"
                                    onclick="${isChecked ? '' : `window.updateVote(${qIndex}, ${oIndex})`}"
                                >
                                    <span class="text-base">${option}</span>
                                    <span class="font-semibold text-sm text-gray-500">
                                        (${currentVoteCount} votes)
                                    </span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <p class="mt-4 text-center text-sm text-gray-500">
                    Total Votes Cast: ${totalVotesCast}. 
                    Group Majority Vote: Option ${majorityAnswerIndex !== -1 ? majorityAnswerIndex + 1 : 'N/A'} (with ${maxVotes} votes)
                </p>
            `;

            // 2. Render Navigation Controls
            const prevButton = `<button onclick="navigateQuestion(-1)" ${qIndex === 0 ? 'disabled' : ''} class="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-lg transition duration-200 disabled:opacity-50">← Previous</button>`;
            
            let checkButton;

            if (!isChecked) {
                // LOCK IN / CHECK BUTTON (disabled until at least 1 vote is cast)
                const isVoted = totalVotesCast > 0;
                checkButton = `<button id="lock-in-btn" onclick="checkAnswer()" ${!isVoted ? 'disabled' : ''} class="w-full sm:w-auto px-8 py-3 text-white font-bold rounded-xl shadow-lg transition duration-200 text-lg disabled:opacity-50">
                                LOCK IN GROUP VOTE!
                              </button>`;
            } else {
                 // NEXT BUTTON
                if (qIndex < totalQuestions - 1) {
                    checkButton = `<button onclick="navigateQuestion(1)" class="w-full sm:w-auto px-8 py-3 bg-secondary-blue hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition duration-200 text-lg">
                                    Next Question →
                                  </button>`;
                } else {
                    checkButton = `<button onclick="showFinalResults()" class="w-full sm:w-auto px-8 py-3 bg-primary-green hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition duration-200 text-lg">
                                    Finish Test and Score!
                                  </button>`;
                }
            }


            navigationControls.innerHTML = `
                <div class="flex-shrink-0">${prevButton}</div>
                <div class="flex-grow">${checkButton}</div>
                <div class="flex-shrink-0">
                    <button onclick="navigateQuestion(1)" ${qIndex >= totalQuestions - 1 || !isChecked ? 'disabled' : ''} class="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-lg transition duration-200 disabled:opacity-50">Next →</button>
                </div>
            `;
            
            // 3. Render Feedback
            if (isChecked !== undefined) {
                feedbackBox.classList.remove('hidden', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-800', 'bg-red-100', 'border-red-400', 'text-red-800');
                
                const majorityCorrect = majorityAnswerIndex === correctAnswerIndex;

                if (majorityCorrect) {
                    feedbackBox.classList.add('bg-green-100', 'border-green-400', 'text-green-800');
                    feedbackBox.innerHTML = '<p class="font-bold">✅ Correct!</p> <p>The class majority matched the fixed answer key. Great collective work!</p>';
                } else {
                    feedbackBox.classList.add('bg-red-100', 'border-red-400', 'text-red-800');
                    feedbackBox.innerHTML = '<p class="font-bold">❌ Incorrect.</p> <p>The class majority did not match the fixed answer key. The correct option is highlighted in green.</p>';
                }
            } else {
                feedbackBox.classList.add('hidden');
            }


            // Scroll to the question content only on initial load
            questionContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            saveData();
        }

        // Handles checking the answer for the current question
        function checkAnswer() {
            const currentTest = tests[state.currentTestIndex];
            const qData = currentTest.questions[state.currentQuestionIndex];
            const qIndex = state.currentQuestionIndex;
            const testId = currentTest.id;

            const currentQuestionVotes = state.allVotes[testId][`q${qIndex}`];
            const totalVotesCast = currentQuestionVotes.reduce((sum, count) => sum + count, 0);

            if (totalVotesCast === 0) {
                // Should not happen as button is disabled, but for safety:
                console.error("Attempted check without voting.");
                return;
            }
            
            const majorityIndex = state.majorityVote[testId][qIndex];
            const isCorrect = majorityIndex === qData.correct;
            
            // Record the check status (if not already checked)
            if (state.questionStatus[testId][qIndex] === undefined) {
                state.questionStatus[testId][qIndex] = isCorrect;
                saveData();
            }
            
            // Re-render the current question to show fixed-key feedback and enable next button
            displayCurrentQuestion();
        }

        // Handles moving between questions
        function navigateQuestion(direction) {
            const currentTest = tests[state.currentTestIndex];
            const newIndex = state.currentQuestionIndex + direction;

            if (newIndex >= 0 && newIndex < currentTest.questions.length) {
                state.currentQuestionIndex = newIndex;
                displayCurrentQuestion();
            } else if (newIndex === currentTest.questions.length && direction === 1) {
                showFinalResults();
            }
            saveData();
        }

        // Calculates and displays the final score for the current test
        function showFinalResults() {
            const currentTest = tests[state.currentTestIndex];
            const testId = currentTest.id;
            let score = 0;
            const totalQuestions = currentTest.questions.length;
            
            // Calculate final score based on class majority vs. correct answer
            for (let i = 0; i < totalQuestions; i++) {
                const majorityIndex = state.majorityVote[testId][i];
                const isCorrect = majorityIndex === currentTest.questions[i].correct;
                
                // Ensure a majority was determined before scoring
                if (majorityIndex !== -1) {
                    if (isCorrect) {
                        score++;
                    }
                    // Final record of status (in case user skipped checkAnswer)
                    state.questionStatus[testId][i] = isCorrect;
                }
            }
            saveData();

            // Display overall results
            const color = score >= totalQuestions * 0.7 ? 'text-primary-green' : 'text-red-500';
            const message = score >= totalQuestions * 0.7 ? "Excellent class performance! The majority opinion was correct on most questions." : "Good effort! Let's review the topics where the class majority was incorrect.";
            
            quizContainer.innerHTML = `
                <div class="text-center p-6 sm:p-10">
                    <h2 class="text-4xl font-extrabold text-quiz-purple mb-4">Test Complete! 🎉</h2>
                    <p class="text-xl font-bold text-gray-800">Final Class Score for ${currentTest.title}:</p>
                    <p class="text-6xl font-black mt-4 ${color}">${score} / ${totalQuestions}</p>
                    <p class="text-md text-gray-700 mt-4 max-w-md mx-auto">${message}</p>
                    
                    <div class="mt-8 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 justify-center">
                        <button onclick="navigateTest(1)" class="px-6 py-3 bg-secondary-blue hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                            ${state.currentTestIndex < tests.length - 1 ? 'Go to Next Test' : 'Quiz Complete!'}
                        </button>
                        <button onclick="navigateTest(0)" class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-xl shadow-lg transition duration-200">
                            Review Test 
                        </button>
                    </div>
                </div>
            `;
            quizContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Handles navigation between different tests
        function navigateTest(direction) {
            const newIndex = state.currentTestIndex + direction;
            if (newIndex >= 0 && newIndex < tests.length) {
                state.currentTestIndex = 0; // Start new test at first question
                state.isReadingPhase = true;
                state.currentTestIndex = newIndex;
                renderCurrentTest();
            } else if (newIndex === tests.length) {
                 quizContainer.innerHTML = `
                    <div class="text-center p-6 sm:p-10">
                        <h2 class="text-4xl font-extrabold text-primary-green mb-4">All Quizzes Finished!</h2>
                        <p class="text-xl text-gray-700">You have completed all the Technical English quizzes available.</p>
                        <button onclick="navigateTest(0)" class="mt-6 px-6 py-3 bg-secondary-blue hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                            Start Reviewing
                        </button>
                    </div>
                `;
            }
            saveData();
        }
        
        // Expose functions globally for HTML calls
        window.updateVote = updateVote;
        window.startQuestions = startQuestions;
        window.checkAnswer = checkAnswer;
        window.navigateQuestion = navigateQuestion;
        window.showFinalResults = showFinalResults;
        window.renderCurrentTest = renderCurrentTest;
        window.navigateTest = navigateTest;
        window.resetAllData = resetAllData; 

        // Initialize the app on load
        initQuiz();
    </script>
</body>
</html>
