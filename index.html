<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awesome Technical English Quiz (Real-Time Tally) üöÄ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles based on the provided design image */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #9333ea; /* Purple background color */
            background-image: url('data:image/svg+xml;utf8,<svg width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="pattern-07e53f" patternUnits="userSpaceOnUse" width="100" height="100" patternTransform="scale(1) rotate(0)"><path d="M 0 0 L 0 50 L 50 100 L 100 50 L 50 0 L 0 50" stroke="%23a855f7" stroke-width="1.5" fill="none"/></pattern></defs><rect width="100%" height="100%" fill="url(%23pattern-07e53f)" opacity="0.3"/></svg>');
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 600px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .option-label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid #3b82f6; /* Blue border for all options */
            color: #1f2937;
            background-color: #eff6ff; /* Light blue background */
        }
        .option-label:hover {
            background-color: #dbeafe; /* Lighter blue on hover */
        }
        /* Highlight for the option with the current majority of votes */
        .option-label.majority {
            border-width: 4px; /* Thicker border for majority */
            border-color: #3b82f6;
            background-color: #dbeafe; /* Slightly darker light blue */
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -2px rgba(59, 130, 246, 0.2);
        }
        /* Highlight for the FIXED correct answer after locking in */
        .option-label.correct {
            border-color: #10b981; /* Green border for correct */
            background-color: #d1fae5; /* Light green background */
        }
        /* Highlight for the INCORRECT group majority answer after locking in */
        .option-label.incorrect-majority {
            border-color: #ef4444; /* Red border for incorrect majority */
            background-color: #fee2e2; /* Light red background */
        }
        
        /* Custom button styling */
        #lock-in-btn {
            background-color: #10b981; /* Primary Green */
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
            box-shadow: 0 4px 0 0 #059669; /* Darker green shadow */
            transition: all 0.1s ease-in-out;
        }
        #lock-in-btn:hover {
            background-color: #059669;
        }
        #lock-in-btn:active {
            box-shadow: 0 1px 0 0 #059669;
            transform: translateY(3px);
        }
        .red-button {
            background-color: #ef4444;
            box-shadow: 0 4px 0 0 #dc2626;
        }
        .red-button:hover {
            background-color: #dc2626;
        }
        .red-button:active {
            box-shadow: 0 1px 0 0 #dc2626;
            transform: translateY(3px);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-green': '#10b981',
                        'secondary-blue': '#3b82f6',
                        'quiz-purple': '#9333ea',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto">
        <div id="quiz-container" class="card p-6 sm:p-8">
            <!-- Dynamic quiz content will be rendered here -->
        </div>
        
        <div class="text-center mt-6">
            <button onclick="window.resetAllData()" class="red-button px-4 py-2 text-white font-bold text-sm rounded-lg shadow-lg transition duration-200">
                Reset All Votes & Progress
            </button>
            <p class="text-xs text-white opacity-80 mt-1">Clears all stored data to restart with 0 votes on all questions.</p>
        </div>
    </div>

    <script>
        // --- QUIZ DATA (A2 Level Content) ---
        const tests = [
            {
                id: 'test_a2_web1',
                title: 'Passage 1: The Browser and the Homepage',
                icon: 'üñ•Ô∏è Websites Quiz üåê',
                text: 
                    "Every day, we use the Internet. To do this, we need a special program called a **Browser**. A Browser is a tool we open to find websites, like Chrome or Safari. When you open your browser, it is usually fast. When you start visiting a website, the website must **Load**. To Load means the website is getting ready to show you the pages. The first page you see is the **Homepage**. The Homepage is the main page where you can start your search. We always **Open** the Browser and then the pages **Load**.",
                questions: [
                    { q: "What is the special program used to find websites?", options: ["The Icon", "The Browser", "The Button", "The Code"], correct: 1 },
                    { q: "What is the job of a Browser?", options: ["To close the computer.", "To find websites.", "To type a name.", "To save a picture."], correct: 1 },
                    { q: "What does it mean when a website must 'Load'?", options: ["It is closing down.", "It is getting ready to show pages.", "It is sending an email.", "It is clicking a button."], correct: 1 },
                    { q: "What is the name of the first, main page of a website?", options: ["The End Page", "The Home Page", "The Address Bar", "The Settings"], correct: 1 },
                    { q: "What is an example of a Browser?", options: ["A button.", "The Homepage.", "Chrome.", "The URL."], correct: 2 },
                    { q: "Where do you start your search on a website?", options: ["The Address Bar.", "The Loading screen.", "The Homepage.", "The Contacts List."], correct: 2 },
                    { q: "What do you do to the Browser to start using it?", options: ["Delete it.", "Open it.", "Type it.", "Scroll it."], correct: 1 },
                    { q: "If the website is Load-ing, what is it doing?", options: ["Stopping.", "Moving fast.", "Starting.", "Breaking."], correct: 2 },
                    { q: "A website is like a digital...", options: ["Key.", "Phone.", "House.", "Secret."], correct: 2 },
                    { q: "What must you do after you open the browser?", options: ["Wait for the page to Close.", "Wait for the pages to Load.", "Wait for the pages to Tap.", "Wait for the pages to Click."], correct: 1 },
                ]
            },
            {
                id: 'test_a2_web2',
                title: 'Passage 2: Address and Controls (URL, Button, Icon)',
                icon: 'üìç Website Location üñ±Ô∏è',
                text: 
                    "A website has a **Location**. The full address of the website is called the **URL** (for example: www.google.com). You must **Type** this URL into the **Address Bar** at the top of the screen. When you use the mouse, you **Click** on things. If you use a phone screen, you **Tap**. A **Button** is a place you click to do an action, like 'Send' or 'Save'. An **Icon** is a small picture that links to something, like a camera icon for photos or a small house icon for the Homepage. Sometimes you need to **Scroll** down to see the whole page.",
                questions: [
                    { q: "What is the full address of a website called?", options: ["The Button", "The Icon", "The URL", "The Homepage"], correct: 2 },
                    { q: "Where do you type the URL?", options: ["The Button", "The Address Bar", "The Contacts List", "The Keyboard"], correct: 1 },
                    { q: "What action do you do with the mouse?", options: ["Tap", "Type", "Scroll", "Click"], correct: 3 },
                    { q: "What is the action when you use a phone screen?", options: ["Click", "Scroll", "Tap", "Load"], correct: 2 },
                    { q: "What is a Button used for?", options: ["To find a new Browser.", "To open a new phone.", "To do an action like 'Send'.", "To check the URL."], correct: 2 },
                    { q: "What is an Icon?", options: ["A large text box.", "A small picture that links to something.", "The full address.", "The name of a Browser."], correct: 1 },
                    { q: "What do you do when you want to write words in a search box?", options: ["Click", "Scroll", "Type", "Tap"], correct: 2 },
                    { q: "If you need to move down to see the whole page, what do you do?", options: ["Close the page.", "Scroll.", "Click the URL.", "Open a new Browser."], correct: 1 },
                    { q: "What is a good example of an Icon?", options: ["The Address Bar.", "A small house picture for the Homepage.", "The word 'Type'.", "A long URL."], correct: 1 },
                    { q: "URL stands for:", options: ["You Read Long.", "You Are Looking.", "You Use Logic.", "Yoo-Are-Ell."], correct: 3 },
                ]
            },
            {
                id: 'test_a2_cyber1',
                title: 'Passage 3: Password Sharing and Secrets',
                icon: 'üîí Cyber Safety: Basic Rules üîë',
                text: 
                    "**CYBER SAFETY** is your job to stay safe in the Internet world. Your password is your **SECRET KEY**. This key lets you enter your account. **PASSWORD SHARING** is when you give your secret key to someone else, even a friend. This is the **biggest risk**. The rule is simple: you must **NEVER** share your password. **SECRET INFO** is information that tells people who you are in the real world (like your full name or home address). You must **ASK AN ADULT** before giving Secret Info. You can also use **2-STEP LOGIN** (key and code from your phone) to keep your account very strong.",
                questions: [
                    { q: "What is Cyber Safety about?", options: ["Typing fast.", "Staying safe in the Internet world.", "Sharing passwords.", "Making a Fake Profile."], correct: 1 },
                    { q: "What is your password called?", options: ["The Big Risk", "The Location Tag", "The Secret Key", "The Trick Message"], correct: 2 },
                    { q: "What is the simple rule for your password?", options: ["Share it with your best friend.", "NEVER share it.", "Write it on your computer.", "Give it to Tom."], correct: 1 },
                    { q: "What is PASSWORD SHARING?", options: ["Using a new name.", "Giving your secret key to someone else.", "Asking an adult.", "Typing a URL."], correct: 1 },
                    { q: "What is the biggest risk mentioned in the text?", options: ["Loading a page.", "Opening the browser.", "Password Sharing.", "Clicking a button."], correct: 2 },
                    { q: "What is SECRET INFO?", options: ["Your phone's color.", "Your full name or home address.", "The name of a website.", "The name of your browser."], correct: 1 },
                    { q: "Who should you ask before giving Secret Info?", options: ["Your friend Tom.", "An Adult.", "A Fake Profile.", "The Button."], correct: 1 },
                    { q: "What makes your account very strong?", options: ["A Trick Message.", "A Location Tag.", "A long URL.", "2-STEP LOGIN."], correct: 3 },
                    { q: "How many steps does 2-STEP LOGIN need?", options: ["One thing.", "Two things (key and code).", "Three things.", "Four things."], correct: 1 },
                    { q: "What does the word 'NEVER' mean?", options: ["Sometimes.", "Once.", "Not ever.", "Maybe."], correct: 2 },
                ]
            },
            {
                id: 'test_a2_cyber2',
                title: 'Passage 4: Fake Profiles and Trick Messages',
                icon: 'üõë Cyber Safety: Danger Signs üëª',
                text: 
                    "Sometimes you see a **FAKE PROFILE**. This is a false or untrue account, and they try to **Trick** you. A new friend request can be **Suspicious** (strange or possibly dangerous). You must **LOOK HARD** at the profile. If they have no photos or friends, **BLOCK** them. Another risk is a **TRICK MESSAGE**. This message tries to fool you, like saying 'URGENT! Your account will close! Click here to fix it!' If you get a Trick Message, you must **STOP and CHECK** the sender's name. If it is strange, you must **DELETE** the message. **DO NOT** click the link quickly.",
                questions: [
                    { q: "What is a FAKE PROFILE?", options: ["A fun game.", "A false or untrue account.", "A new Browser.", "A special Button."], correct: 1 },
                    { q: "What does a Fake Profile try to do to you?", options: ["Block you.", "Look Hard.", "Trick you.", "Save the Proof."], correct: 2 },
                    { q: "If a friend request looks strange, it is...", options: ["Urgent.", "Suspicious.", "Official.", "Safe."], correct: 1 },
                    { q: "What should you do if a profile is suspicious?", options: ["Add them quickly.", "LOOK HARD at the profile.", "Share your password.", "Give them your Secret Info."], correct: 1 },
                    { q: "If a profile is strange, what should you do instead of adding them?", options: ["Reply.", "Scroll.", "BLOCK them.", "Ask an adult."], correct: 2 },
                    { q: "What is a TRICK MESSAGE?", options: ["A message that tells the truth.", "A message that lies to fool you.", "A message from your teacher.", "A message about the Homepage."], correct: 1 },
                    { q: "If a message says 'URGENT!', what should you do?", options: ["Click the link quickly.", "STOP and CHECK the sender.", "Delete your account.", "Download a free game."], correct: 1 },
                    { q: "What does 'DELETE' mean?", options: ["To send a message.", "To remove a file or message.", "To open a new page.", "To click on a button."], correct: 1 },
                    { q: "What is the instruction if the sender's address of a message is strange?", options: ["Share the message.", "DELETE the message.", "Ask for the URL.", "Type the message again."], correct: 1 },
                    { q: "What does 'LOOK HARD' mean?", options: ["To run away.", "To check carefully.", "To be fast.", "To close your eyes."], correct: 1 },
                ]
            }
        ];


        // --- STATE AND LOCAL STORAGE MANAGEMENT ---
        let state = {
            currentTestIndex: 0,
            currentQuestionIndex: 0,
            isReadingPhase: true,
            // Stores vote counts as an array: { 'test1-q0': [3, 5, 2, 0] }
            allVotes: {}, 
            // Stores the correct/incorrect status for fixed answer key comparison
            questionStatus: tests.reduce((acc, test) => { acc[test.id] = {}; return acc; }, {}),
            // Stores the index of the option that currently holds the majority vote
            majorityVote: tests.reduce((acc, test) => { acc[test.id] = {}; return acc; }, {}),
        };
        
        const quizContainer = document.getElementById('quiz-container');

        // Load data from local storage
        function loadData() {
            const storedVotes = localStorage.getItem('quizAllVotes');
            if (storedVotes) {
                state.allVotes = JSON.parse(storedVotes);
            }

            const storedState = localStorage.getItem('quizState');
            if (storedState) {
                const loadedState = JSON.parse(storedState);
                state.currentTestIndex = loadedState.currentTestIndex || 0;
                state.currentQuestionIndex = loadedState.currentQuestionIndex || 0;
                state.isReadingPhase = loadedState.isReadingPhase !== undefined ? loadedState.isReadingPhase : true;
                state.questionStatus = loadedState.questionStatus || state.questionStatus;
                state.majorityVote = loadedState.majorityVote || loadedState.majorityVote;
            }
            
             // Initialize votes array for all questions if not present
            tests.forEach(test => {
                if (!state.allVotes[test.id]) state.allVotes[test.id] = {};
                test.questions.forEach((qData, qIndex) => {
                    const key = `q${qIndex}`;
                    if (!state.allVotes[test.id][key]) {
                        // Ensure all 10 questions have an initialized vote array
                        state.allVotes[test.id][key] = new Array(qData.options.length).fill(0); 
                    }
                });
            });
        }

        // Save current state to local storage
        function saveData() {
            localStorage.setItem('quizAllVotes', JSON.stringify(state.allVotes));
            localStorage.setItem('quizState', JSON.stringify({
                currentTestIndex: state.currentTestIndex,
                currentQuestionIndex: state.currentQuestionIndex,
                isReadingPhase: state.isReadingPhase,
                questionStatus: state.questionStatus,
                majorityVote: state.majorityVote,
            }));
        }


        // --- CORE QUIZ LOGIC ---

        // Initial setup function
        function initQuiz() {
            loadData();
            renderCurrentTest();
        }
        
        // Function to clear all local storage data and restart the quiz
        function resetAllData() {
            localStorage.clear();
            window.location.reload(); 
        }

        // Renders the main structure for the current test (Reading Text + Question Area)
        function renderCurrentTest() {
            const currentTest = tests[state.currentTestIndex];
            
            if (state.isReadingPhase) {
                 state.currentQuestionIndex = 0;
            }

            // Set up the reading text section
            const readingSection = `
                <div id="reading-section" class="bg-gray-50 p-6 rounded-lg text-gray-700 border-l-4 border-quiz-purple/50 ${state.isReadingPhase ? '' : 'hidden'}">
                    <p class="whitespace-pre-wrap text-base leading-relaxed">${currentTest.text}</p>
                    <p class="text-sm text-gray-500 mt-4 text-center">This section has questions 1 to ${currentTest.questions.length}.</p>
                    
                    <button onclick="startQuestions()" id="start-btn" class="mt-6 w-full red-button px-6 py-4 text-white font-bold rounded-xl shadow-lg transition duration-200 text-xl">
                        Start Questions for ${currentTest.title.replace('Passage ', 'Text ')}
                    </button>
                </div>
            `;
            
            // Set up the main quiz container
            quizContainer.innerHTML = `
                <header class="text-center mb-6">
                    <h1 class="text-2xl font-extrabold text-quiz-purple">${currentTest.icon}</h1>
                    <h2 class="text-xl font-bold text-gray-700 mt-1">${currentTest.title}</h2>
                </header>

                <div id="quiz-body">
                    ${readingSection}

                    <!-- Question Section -->
                    <div id="question-section" class="${state.isReadingPhase ? 'hidden' : ''}">
                        <div id="question-content">
                            <!-- Question and options will be injected here -->
                        </div>
                        <div id="navigation-controls" class="mt-8 flex justify-between space-x-4">
                            <!-- Navigation buttons injected here -->
                        </div>
                    </div>
                </div>

                <!-- Message Box for Feedback (Kept but always hidden to follow user request) -->
                <div id="feedback-box" class="mt-6 p-4 rounded-lg hidden">
                    <!-- Feedback is intentionally left empty/hidden as per user request -->
                </div>
            `;
            
            if (!state.isReadingPhase) {
                displayCurrentQuestion();
            }

            saveData();
        }

        // Hides reading text and shows the current question
        function startQuestions() {
            document.getElementById('reading-section').classList.add('hidden');
            document.getElementById('question-section').classList.remove('hidden');
            state.isReadingPhase = false;
            displayCurrentQuestion();
        }
        
        // Increments the vote count for the selected option by 1
        function updateVote(qIndex, selectedOptionIndex) {
            const currentTest = tests[state.currentTestIndex];
            const testId = currentTest.id;
            const key = `q${qIndex}`;

            // Increment the specific option's count
            if (state.allVotes[testId] && state.allVotes[testId][key]) {
                state.allVotes[testId][key][selectedOptionIndex]++;
            } else {
                 console.error("Vote array not initialized!");
                 return;
            }
            
            saveData();
            
            // Re-render to show the updated vote counts and majority
            displayCurrentQuestion();
        }

        // Renders the current question based on state.currentQuestionIndex
        function displayCurrentQuestion() {
            const currentTest = tests[state.currentTestIndex];
            const qData = currentTest.questions[state.currentQuestionIndex];
            const qIndex = state.currentQuestionIndex;
            const testId = currentTest.id;
            const totalQuestions = currentTest.questions.length;
            const key = `q${qIndex}`;
            
            const questionContent = document.getElementById('question-content');
            const navigationControls = document.getElementById('navigation-controls');
            const feedbackBox = document.getElementById('feedback-box');

            const currentQuestionVotes = state.allVotes[testId] ? state.allVotes[testId][key] : new Array(qData.options.length).fill(0);
            
            // --- TALLY VOTES AND FIND MAJORITY ---
            let maxVotes = -1;
            let majorityAnswerIndex = -1;
            let totalVotesCast = 0;
            
            currentQuestionVotes.forEach((count, index) => {
                totalVotesCast += count;
                if (count > maxVotes) {
                    maxVotes = count;
                    majorityAnswerIndex = index;
                }
            });

            // Update stored majority for tracking and scoring
            if (!state.majorityVote[testId]) state.majorityVote[testId] = {};
            state.majorityVote[testId][qIndex] = majorityAnswerIndex;


            const isChecked = state.questionStatus[testId] && state.questionStatus[testId][qIndex] !== undefined;
            const isCorrect = isChecked ? state.questionStatus[testId][qIndex] : undefined;
            const correctAnswerIndex = qData.correct;

            // 1. Render Question Content
            questionContent.innerHTML = `
                <p class="text-center text-gray-500 mb-4 font-semibold">Question ${qIndex + 1} of ${totalQuestions}</p>
                <div class="question p-4 rounded-lg">
                    <p class="font-bold text-xl text-gray-800 mb-4">
                        ${qIndex + 1}. ${qData.q}
                    </p>
                    <div class="options space-y-3">
                        ${qData.options.map((option, oIndex) => {
                            const inputName = `${testId}-q${qIndex}`;
                            const isMajorityAnswer = oIndex === majorityAnswerIndex && maxVotes > 0;
                            const currentVoteCount = currentQuestionVotes[oIndex];

                            let labelClass = 'flex items-center justify-between p-4 rounded-xl option-label';
                            
                            // Highlight current vote majority (blue border)
                            if (isMajorityAnswer && !isChecked) {
                                labelClass += ' majority';
                            }
                            
                            // Fixed answer feedback (Visual only, after checking)
                            if (isChecked) {
                                // Highlight the FIXED correct answer with green
                                if (oIndex === correctAnswerIndex) {
                                    labelClass += ' correct';
                                }
                                // Highlight the group's chosen majority (if incorrect) with red
                                else if (oIndex === majorityAnswerIndex && oIndex !== correctAnswerIndex) {
                                     labelClass += ' incorrect-majority';
                                }
                                // Disable interactions after checking
                                labelClass += ' cursor-default';
                            }
                            
                            // The radio button is just for tracking the last clicked option, but the key is the onClick on the label
                            return `
                                <label 
                                    class="${labelClass}" 
                                    for="${inputName}-o${oIndex}"
                                    onclick="${isChecked ? '' : `window.updateVote(${qIndex}, ${oIndex})`}"
                                >
                                    <span class="text-base">${option}</span>
                                    <span class="font-semibold text-sm text-gray-500">
                                        (${currentVoteCount} votes)
                                    </span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <p class="mt-4 text-center text-sm text-gray-500">
                    Total Votes Cast: ${totalVotesCast}. 
                    Group Majority Vote: Option ${majorityAnswerIndex !== -1 ? majorityAnswerIndex + 1 : 'N/A'} (with ${maxVotes} votes)
                </p>
            `;

            // 2. Render Navigation Controls
            const prevButton = `<button onclick="navigateQuestion(-1)" ${qIndex === 0 ? 'disabled' : ''} class="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-lg transition duration-200 disabled:opacity-50">‚Üê Previous</button>`;
            
            let checkButton;

            if (!isChecked) {
                // LOCK IN / CHECK BUTTON (disabled until at least 1 vote is cast)
                const isVoted = totalVotesCast > 0;
                checkButton = `<button id="lock-in-btn" onclick="checkAnswer()" ${!isVoted ? 'disabled' : ''} class="w-full sm:w-auto px-8 py-3 text-white font-bold rounded-xl shadow-lg transition duration-200 text-lg disabled:opacity-50">
                                LOCK IN GROUP VOTE!
                              </button>`;
            } else {
                 // NEXT BUTTON
                if (qIndex < totalQuestions - 1) {
                    checkButton = `<button onclick="navigateQuestion(1)" class="w-full sm:w-auto px-8 py-3 bg-secondary-blue hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition duration-200 text-lg">
                                    Next Question ‚Üí
                                  </button>`;
                } else {
                    checkButton = `<button onclick="showFinalResults()" class="w-full sm:w-auto px-8 py-3 bg-primary-green hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition duration-200 text-lg">
                                    Finish Test and Score!
                                  </button>`;
                }
            }


            navigationControls.innerHTML = `
                <div class="flex-shrink-0">${prevButton}</div>
                <div class="flex-grow flex justify-center">${checkButton}</div>
                <div class="flex-shrink-0">
                    <button onclick="navigateQuestion(1)" ${qIndex >= totalQuestions - 1 && isChecked ? '' : 'disabled'} class="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded-lg transition duration-200 disabled:opacity-50">Next ‚Üí</button>
                </div>
            `;
            
            // 3. Render Feedback (REMOVED EXPLICIT TEXT FEEDBACK AS REQUESTED)
            // The visual feedback (green/red borders) applied in step 1 remains.
            feedbackBox.classList.add('hidden');


            // Scroll to the question content only on initial load
            questionContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            saveData();
        }

        // Handles checking the answer for the current question
        function checkAnswer() {
            const currentTest = tests[state.currentTestIndex];
            const qData = currentTest.questions[state.currentQuestionIndex];
            const qIndex = state.currentQuestionIndex;
            const testId = currentTest.id;

            const currentQuestionVotes = state.allVotes[testId][`q${qIndex}`];
            const totalVotesCast = currentQuestionVotes.reduce((sum, count) => sum + count, 0);

            if (totalVotesCast === 0) {
                // Should not happen as button is disabled, but for safety:
                console.error("Attempted check without voting.");
                return;
            }
            
            const majorityIndex = state.majorityVote[testId][qIndex];
            const isCorrect = majorityIndex === qData.correct;
            
            // Record the check status (if not already checked)
            if (state.questionStatus[testId][qIndex] === undefined) {
                state.questionStatus[testId][qIndex] = isCorrect;
                saveData();
            }
            
            // Re-render the current question to show fixed-key feedback and enable next button
            displayCurrentQuestion();
        }

        // Handles moving between questions
        function navigateQuestion(direction) {
            const currentTest = tests[state.currentTestIndex];
            const newIndex = state.currentQuestionIndex + direction;
            const qIndex = state.currentQuestionIndex;

            // Only allow navigation if the current question is checked, or if moving backward
            const isChecked = state.questionStatus[currentTest.id][qIndex] !== undefined;

            if (direction === -1 || (direction === 1 && isChecked) ) {
                 if (newIndex >= 0 && newIndex < currentTest.questions.length) {
                    state.currentQuestionIndex = newIndex;
                    displayCurrentQuestion();
                } else if (newIndex === currentTest.questions.length && direction === 1) {
                    showFinalResults();
                }
            }
            saveData();
        }

        // Calculates and displays the final score for the current test
        function showFinalResults() {
            const currentTest = tests[state.currentTestIndex];
            const testId = currentTest.id;
            let score = 0;
            const totalQuestions = currentTest.questions.length;
            
            // Calculate final score based on class majority vs. correct answer
            for (let i = 0; i < totalQuestions; i++) {
                const majorityIndex = state.majorityVote[testId][i];
                const isCorrect = majorityIndex === currentTest.questions[i].correct;
                
                // Ensure a majority was determined before scoring
                if (majorityIndex !== -1) {
                    if (isCorrect) {
                        score++;
                    }
                    // Final record of status (in case user skipped checkAnswer)
                    state.questionStatus[testId][i] = isCorrect;
                }
            }
            saveData();

            // Display overall results
            const color = score >= totalQuestions * 0.7 ? 'text-primary-green' : 'text-red-500';
            const message = score >= totalQuestions * 0.7 ? "Excellent class performance! The majority opinion was correct on most questions." : "Good effort! Let's review the topics where the class majority was incorrect.";
            
            quizContainer.innerHTML = `
                <div class="text-center p-6 sm:p-10">
                    <h2 class="text-4xl font-extrabold text-quiz-purple mb-4">Test Complete! üéâ</h2>
                    <p class="text-xl font-bold text-gray-800">Final Class Score for ${currentTest.title.replace('Passage ', 'Text ')}:</p>
                    <p class="text-6xl font-black mt-4 ${color}">${score} / ${totalQuestions}</p>
                    <p class="text-md text-gray-700 mt-4 max-w-md mx-auto">${message}</p>
                    
                    <div class="mt-8 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 justify-center">
                        <button onclick="navigateTest(1)" class="px-6 py-3 bg-secondary-blue hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                            ${state.currentTestIndex < tests.length - 1 ? 'Go to Next Test' : 'Quiz Complete!'}
                        </button>
                        <button onclick="navigateTest(0)" class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-xl shadow-lg transition duration-200">
                            Review Test 
                        </button>
                    </div>
                </div>
            `;
            quizContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Handles navigation between different tests
        function navigateTest(direction) {
            const newIndex = state.currentTestIndex + direction;
            if (newIndex >= 0 && newIndex < tests.length) {
                state.currentQuestionIndex = 0; // Start new test at first question
                state.isReadingPhase = true;
                state.currentTestIndex = newIndex;
                renderCurrentTest();
            } else if (newIndex === tests.length) {
                 quizContainer.innerHTML = `
                    <div class="text-center p-6 sm:p-10">
                        <h2 class="text-4xl font-extrabold text-primary-green mb-4">All Quizzes Finished!</h2>
                        <p class="text-xl text-gray-700">You have completed all ${tests.length} Technical English quizzes available.</p>
                        <button onclick="navigateTest(0)" class="mt-6 px-6 py-3 bg-secondary-blue hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition duration-200">
                            Start Reviewing
                        </button>
                    </div>
                `;
            }
            saveData();
        }
        
        // Expose functions globally for HTML calls
        window.updateVote = updateVote;
        window.startQuestions = startQuestions;
        window.checkAnswer = checkAnswer;
        window.navigateQuestion = navigateQuestion;
        window.showFinalResults = showFinalResults;
        window.renderCurrentTest = renderCurrentTest;
        window.navigateTest = navigateTest;
        window.resetAllData = resetAllData; 

        // Initialize the app on load
        initQuiz();
    </script>
</body>
</html>
